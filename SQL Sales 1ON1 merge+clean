SELECT  A.* ,
        CASE SUBJECT_DESC 
        WHEN '1ON1' 
        THEN (CASE
              WHEN UPPER(COURSE_NAME) LIKE '%SAT MATH%' THEN 'I-SAT-CU-M' 
              WHEN UPPER(COURSE_NAME) LIKE '%VERBAL%' THEN 'I-SAT-ENG'
              WHEN UPPER(COURSE_NAME) LIKE '%SAT II%' THEN 'I-SAT-SUBT'
              WHEN UPPER(COURSE_NAME) LIKE '%BMAT%' THEN 'I-BMAT' 
              WHEN UPPER(COURSE_NAME) LIKE '%IELTS%' THEN 'I-IELTS' 
              WHEN UPPER(COURSE_NAME) LIKE '%GED%' THEN 'I-GED'
              WHEN UPPER(COURSE_NAME) LIKE '%CU-TEP%' THEN 'I-CU-TEP'
              WHEN UPPER(COURSE_NAME) LIKE '%CUA%' 
                OR UPPER(COURSE_NAME) LIKE '%CU-T%' 
                OR UPPER(COURSE_NAME) LIKE '%CU-A%' 
                OR UPPER(COURSE_NAME) LIKE '%ACT%' THEN 'I-CU-TEST'
              WHEN UPPER(COURSE_NAME) LIKE '%A-LEVEL%' THEN 'A-LEVEL'
              WHEN UPPER(COURSE_NAME) LIKE '%MUIDS%' THEN 'I-MUIDS'
              WHEN UPPER(COURSE_NAME) LIKE '%IGCSE%' THEN 'IGCSE'
              WHEN UPPER(COURSE_NAME) LIKE '%CREDIT%' THEN 'CREDIT'
              WHEN UPPER(COURSE_NAME) LIKE '%AP %' THEN 'AP'
              WHEN UPPER(COURSE_NAME) LIKE '%IB %' THEN 'IB'
              WHEN UPPER(COURSE_NAME) LIKE '%GENIUS%' THEN 'GENIUS'
              WHEN UPPER(COURSE_NAME) LIKE 'MATH%' THEN 'I-MATH'
              WHEN UPPER(COURSE_NAME) LIKE 'ENG%' THEN 'I-ENG'
              WHEN UPPER(COURSE_NAME) LIKE 'BIO%' THEN 'I-BIO'
              WHEN UPPER(COURSE_NAME) LIKE 'PHY%' THEN 'I-PHY'
              WHEN UPPER(COURSE_NAME) LIKE 'CHE%' THEN 'I-CHEM'
              WHEN UPPER(COURSE_NAME) LIKE '%PORT%' THEN 'PORT'
              WHEN UPPER(COURSE_NAME) LIKE '%TOEFL%' THEN 'TOEFL'
              ELSE 'OTHER'
              END 
             )
        ELSE SUBJECT_DESC END AS SUBJECT_ALL
        
FROM     (
          // เคลียร์ที่ RDT_NO ซ้ำ 1,940  rows
          SELECT RDT_NO,STUDENT_CODE,AMOUNT,BILL_STATUS,CUSTOMER_TYPE,
              COURSE_CODE,COURSE_NAME,SUBJECT_DESC,COURSE_TYPE_NAME,SCANCODE,CATEGORY_DESC,
              BRANCHKEY,BRANCH_CODE,BRANCH_DISPLAYCODE,BRANCH_NAME,BRANCH_AREA_NEW,BRANCH_ZONE,BU_CODE,COMPANY_CODE,BU_NAME,
              YEAR_KEY,DATEKEY,SALE_DATE,FIRSTBUY_DATEKEY,
              SUBJECT_DESC_OLD,ORIGINAL_COURSE,SINGLE_PACK,
              ROOM,SCHOOL_NAME,SCHOOL_PROVINCE,SCHOOL_REGION,SCHOOL_TYPE1_NAME,SCHOOL_TYPE2_NAME,SCHOOL_TYPE3_NAME,
                 CONCAT(COURSE_CODE,'-',BILL_NO) AS BILL_CHECK_1  ,
                 COUNT(RDT_NO)  OVER(PARTITION BY RDT_NO) AS CNT_RDT
          FROM "SALE_AND_MARKETING"."B2C"."SALEAMOUNT_B2C"
          WHERE BU_CODE IN ('IGNITE','IG-INTER')
          ORDER BY RDT_NO
         ) AS A
LEFT JOIN (
           SELECT CONCAT(COURSE_CODE,'-',BILL_REF) AS BILL_CHECK_2 
           FROM "SALE_AND_MARKETING"."B2C"."SALEAMOUNT_B2C"
           WHERE BU_CODE IN ('IGNITE','IG-INTER')
                 AND BILL_REF IS NOT NULL
          ) AS B
ON B.BILL_CHECK_2 = A.BILL_CHECK_1

WHERE     CNT_RDT != 2
      AND YEAR_KEY >= 2021
      AND COURSE_TYPE_NAME NOT IN ('PREMIUM' , 'BOOK','DELIVERY','SUMBOOK_CO','EB')
      AND BILL_CHECK_2 IS NULL 
      AND BILL_STATUS NOT IN  ('Cancel','Transfer-O','Return')
      AND CUSTOMER_TYPE IN ('Existing','New')
      AND SUBJECT_DESC != 'TOPUP'
ORDER BY STUDENT_CODE 
